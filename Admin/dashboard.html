<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="../Style/dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Container fluid untuk full width -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-dark min-vh-100 p-0">
                <!-- Load sidebar component -->
                <div id="sidebar-container"></div>
            </div>

            <!-- Main Content - dengan offset untuk sidebar -->
            <div class="col-10">
                <div class="tab-content" id="main-content">
                    <!-- Load users tab component -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for all components to load before initializing
        function loadComponents() {
            // Load sidebar
            fetch('../Components/sidebar.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                });

            // Load users tab
            fetch('../Components/users-tab.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('main-content').innerHTML = html;
                    // Load users.js after the component is loaded
                    const script = document.createElement('script');
                    script.src = '../Script/users.js';
                    document.body.appendChild(script);
                });
        }

        async function loadComponents() {
            try {
                // Load sidebar first
                const sidebarResponse = await fetch('../Components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHtml;
        
                // Then load users tab
                const usersResponse = await fetch('../Components/users-tab.html');
                const usersHtml = await usersResponse.text();
                document.getElementById('main-content').innerHTML = usersHtml;
        
                // Finally load and initialize users.js
                const script = document.createElement('script');
                script.src = '../Script/users.js';
                document.body.appendChild(script);
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', loadComponents);

        // User-related functions
function fetchUsers() {
    fetch('../Controller/get_users.php')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update total users
                document.getElementById('totalUsers').textContent = result.count;
                
                // Update table
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = ''; // Clear existing content
                
                result.data.forEach(user => {
                    const date = new Date(user.created_at).toLocaleDateString();
                    tbody.innerHTML += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${date}</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-2" onclick="editUser(${user.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateTotalUsers() { 
    fetch('../Controller/get_users.php')
        .then(response => response.json())
        .then(data => {
            // Update total users sesuai jumlah data dari database
            document.getElementById('totalUsers').textContent = data.length;
        })
        .catch(error => console.error('Error:', error));
}

function saveUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    
    const user = {
        id: Date.now(),
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password')
    };
    
    users.push(user);
    localStorage.setItem('users', JSON.stringify(users));
    
    renderUsers();
    updateTotalUsers();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    modal.hide();
    form.reset();
}

function editUser(id, username, email) { 
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;

    new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

function deleteUser(id) {if (confirm('Are you sure you want to delete this user?')) {
    fetch('../Controller/delete_user.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fetchUsers(); // Refresh user list
        } else {
            alert('Error deleting user');
        }
    })
    .catch(error => console.error('Error:', error));
}
}

function updateUser() {
    const id = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const password = document.getElementById('editPassword').value;

    const data = {
        id: id,
        username: username,
        email: email
    };
    
    if(password) {
        data.password = password;
    }

    fetch('../Controller/update_user.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if(result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            renderUsers(); // Refresh tabel
            alert('User updated successfully');
        } else {
            alert('Failed to update user: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating user');
    });
}

        function renderUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            
            fetch('../Controller/get_users.php')
                .then(response => response.json())
                .then(data => {
                    data.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.created_at}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editUser(${user.id}, '${user.username}', '${user.email}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm ms-2" onclick="deleteUser(${user.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }
        
        // Panggil kedua fungsi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            fetchUsers();
            renderUsers();
            updateTotalUsers(); // Tambahkan ini
            setInterval(() => {
                renderUsers();
                updateTotalUsers(); // Update total users setiap 3 detik juga
            }, 3000);
        });
    </script>
</body>
</html>